#!/usr/bin/env python
# -*- coding: UTF-8 -*-

import MySQLdb
import json
import sys
import os

db = MySQLdb.connect(
    host = "localhost", port = 3306, user = "root", 
    passwd = "123456", db = "net_test", charset = "utf8"
    )

cursor = db.cursor()

def err_log():
    print "error"
    error_info = sys.exc_info()
    if len(error_info) > 1:
        print(str(error_info[0]) + ' ' + str(error_info[1]))

# 初始情形，type都是1, cveId, cnvdId和type构成组合唯一性约束，防止重复插入
def insertInitItem(item):
    sql = ""
    try:
        sql = """
        insert into vulnerability (`cveId`, `publishedDatetime`, `lastModifiedDatetime`, `summary`, `type`) values 
        ("{cve}", "{pub}", "{last}", "{sum}", 1);
        """.format(cve = item[0], pub = item[1], last = item[2], sum = item[3])
        cursor.execute(sql)
        db.commit()
    except:
        print sql
        err_log()

def clearVulnerability():
    try:
        cursor.execute("""
        delete from vulnerability;
        """)
        db.commit()
    except:
        err_log()

def countRemain():
    try:
        cursor.execute("""
        select count(*) from vulnerability;
        """)
        res = cursor.fetchall()
        print res
    except:
        err_log()

# 初始化vulnerability表，需要整合CNVD和NVD信息
try:
    cursor.execute("""
    select number, publishedDatetime, lastModifiedDatetime, summary from
    entry;
    """)
    data = cursor.fetchall()
    # for item in data:
    #     insertInitItem(item)
    clearVulnerability()
    countRemain()
except:
    err_log()



db.close()