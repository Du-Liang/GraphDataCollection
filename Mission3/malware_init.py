#!/usr/bin/env python
# -*- coding: UTF-8 -*-

import MySQLdb
import json
import sys
import os

db = MySQLdb.connect(
    host = "localhost", port = 3306, user = "root", 
    passwd = "123456", db = "net_test", charset = "utf8"
    )

cursor = db.cursor()

# symantec中的id关联到Malware中的origin_id
# 考虑到可能有别的数据源的malware，这里不把origin_id设置外键关联，默认值为-1
cursor.execute("""
                select Type, x_link, x_title, Risk_Impact, Updated, 
                x_pubDate, Version, Publisher, File_Names,
                Discovered, Also_Known_As, Characteristics,
                Region_Reported, Area_of_infection,
                Likelihood, id from `symantec`;
                """)

data = cursor.fetchall()

# item[0] : Type
# item[1] : x_title
# item[2] : x_link
# ...
# item[13] : Likelihood
for item in data:
    count = 0
    vals = ""
    for key in item:
        count += 1
        if count == len(item): # 最后一个是id
            if key != None:
                # vals += ("\"" + str(key) + "\"")
                vals += str(key)
            else:
                vals += "null"
        else:
            if key != None:
                vals += ("\"" + key + "\"")
                vals += ','
            else:
                vals += "null, "
    sql = "insert into `Malware` (`type`, `link`, `Name`, `Risk_Impact`, `Updated`, `pubDate`, `Version`, `Publisher`, `File_Names`, `Discovered`, `Also_Known_As`, `Characteristics`, `Region_Reported`, `Area_of_infection`, `Likelihood`, `origin_id`) values (" + vals + ");"
    print sql
    try:
        cursor.execute(sql)
        db.commit()
    except:
        print "error!"
        error_info = sys.exc_info()
        if len(error_info) > 1:
            print(str(error_info[0]) + ' ' + str(error_info[1]))
        db.rollback()
db.close()