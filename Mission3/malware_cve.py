#!/usr/bin/env python
# -*- coding: UTF-8 -*-

import MySQLdb
import json
import sys
import os

def err_log():
    print "error"
    error_info = sys.exc_info()
    if len(error_info) > 1:
        print(str(error_info[0]) + ' ' + str(error_info[1]))


db = MySQLdb.connect(
    host = "localhost", port = 3306, user = "root", 
    passwd = "123456", db = "net_test", charset = "utf8"
    )

cursor = db.cursor()

def getMalId(i):
    try:
        cursor.execute("""
        select id from Malware where origin_id = {x};
        """.format(x = i[0]))
        res = cursor.fetchone()
        if res != None:
            return res[0]
        else:
            return None
    except:
        err_log()
        return None

# 用于取vulnerability表中对应记录的id，待修改，vulnerability表还没有完成
# 关注表名、字段名等信息
def getCVEId(i):
    try:
        cursor.execute("""
        select id from vulnerability where cvenumber = "{x}";
        """.format(x = i[1]))
        res = cursor.fetchone()
        if res != None:
            return res[0]
        else:
            return None
    except:
        err_log()
        return None
# insertVertex, getVertexId, insertEdge都可以照搬
# 直接插，表中已经设置了组合键的唯一性约束
def insertVertex(i, t):
    try:
        sql = """
        insert into `vertex` (`type`, `id_search`) values ({m}, {n});
        """.format(m = t, n = i)
        print sql
        cursor.execute(sql)
        db.commit()
    except:
        err_log()
        db.rollback()

def getVertexId(i, t):
    try:
        sql = """
        select id from `vertex` where type = {m} and id_search = {n};
        """.format(m = t, n = i)
        print sql
        cursor.execute(sql)
        res = cursor.fetchone()
        if res != None:
            return res[0]
        else:
            return None 
    except:
        err_log()
        return None

def insertEdge(inId, outId, rel):
    try:
        sql = """
        insert into `Edges` (`type`, `in_vertex_id`, `out_vertex_id`) values ("{relation}", {m}, {n});
        """.format(relation = rel, m = inId, n = outId)
        print sql
        cursor.execute(sql)
        db.commit()
    except:
        err_log()
        db.rollback()

def UpdateRelation(MalId, CVEId):
    print "inserting..."
    print MalId
    print CVEId
    insertVertex(MalId, 6)
    insertVertex(CVEId, 1)
    outId = getVertexId(MalId, 6)
    inId = getVertexId(CVEId, 1)
    print outId
    print inId
    if outId != None and inId != None:
        insertEdge(inId, outId, "affect")
    else:
        print "fail to insert an edge"

try:
    cursor.execute("""
    select id, CVE_References from `symantec` where CVE_References is not null;
    """)
    data = cursor.fetchall()
    for item in data:
        MalId = getMalId(item)
        CVEId = getCVEId(item)
        if MalId == None or CVEId == None:# 不需要我再插入CVE才是，CVE里一定有响应内容
            continue
        else:
            UpdateRelation(MalId, CVEId)
except:
    err_log()

db.close()